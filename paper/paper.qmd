---
title: "Are Lower Income Communities Given More Noise Exemptions"
subtitle: "My subtitle if needed"
author: 
  - Siddharth Gowda
thanks: "Open Data Toronto: https://open.toronto.ca/"
date: today
date-format: long
abstract: "TODO: FINISH THIS LATER"
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(knitr)

# TODO: switch area from kms2 to 10kms2
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

```{r}
#| label: tbl-fulldatasample
#| tbl-cap: "Sample of Noise Exmption Dataset"
#| echo: false
#| warning: false
#| message: false


display_column_names <- c("Permit Type", "Ward Number", "Exemption Issue Year",
                          "Expected Permit End Year", 
                          "Ward Total Area (km squared)",
                          "Ward Total Population", "Ward Median Income (CAD)")

noise_exemp_ward_data_og <- read_csv(
  "../data/analysis_data/clean_noise_exemp_ward_data.csv")

noise_exemp_ward_data_og %>% 
  select(!id) %>% 
  head(1) %>% 
  kable(col.names = display_column_names)
```

## Data History

```{r}
#| label: fig-permityears
#| tbl-cap: "TODO"
#| tbl-sub: ["TODO", "TODO", "TODO"]
#| layout-ncol: 2
#| echo: false
#| warning: false
#| message: false

noise_exemp_ward_data_og %>% group_by(issue_year) %>% 
  summarise(n = n_distinct(id)) %>% kable(
    col.names = c("Issue Year", "Number of Exemptions")
  )

noise_exemp_ward_data_og %>% group_by(expected_end_year) %>% 
  summarise(n = n_distinct(id)) %>% kable(
    col.names = c("Expected End Year", "Number of Exemptions")
  )



```

\newpage

## Types of Permits

```{r}
#| label: tbl-exemptioncategories
#| tbl-cap: "All Exemption Categories"
#| echo: false
#| warning: false
#| message: false

full_permit_type_table = noise_exemp_ward_data_og %>% group_by(permit_type) %>% 
  summarise(freq = n_distinct(id)) %>% 
  kable(col.names = c("Type", "Number of Permits"))

# Amplfied sound is for things like concerts or events

# Construction - self explanatory
# Continous pour (like pouring concerete, essentially like constructions)
# Large Carne (need carne to move things, similar to construction)
# Other sound - self explanatory

full_permit_type_table
```

```{r}
#| label: tbl-relevantexemptioncategories
#| tbl-cap: "Relevant Exemption Categories"
#| echo: false
#| warning: false
#| message: false

# Will merge these into construction, non-construction, other
noise_exemp_ward_data = noise_exemp_ward_data_og %>% 
  mutate(permit_type = case_when(
    str_detect(permit_type, "amplified") ~ "non-construction",
    str_detect(permit_type, "(construction|continuous|crane)") ~ "construction",
    str_detect(permit_type, "other") ~ "other",
    TRUE ~ "other"
  ))


construction_permit_type_table = noise_exemp_ward_data %>% 
  group_by(permit_type) %>% 
  summarise(freq = n_distinct(id)) %>% 
  kable(col.names = c("Type", "Number of Permits"))

construction_permit_type_table


```

\newpage

## Ward Information

```{r}
#| label: fig-wardtotalexemptions
#| fig-cap: "Noise Exemptions by Ward"
#| echo: false
#| warning: false
#| message: false
# ward, number of occurrences

ward_exemptions <- noise_exemp_ward_data %>% 
  select(ward, id, permit_type) %>% 
  group_by(ward) %>% 
  summarise(exemptions = n_distinct(id),
            construction_exemptions = sum(permit_type == "construction"),
            non_construction_exemptions = 
              sum(permit_type == "non-construction"),
            other_exemptions = sum(permit_type == "other"))

ward_exemptions_bar <- noise_exemp_ward_data %>% 
  ggplot(aes(x = ward, fill = permit_type)) +
  geom_bar() +
  theme_linedraw() +
  labs(x = "Ward Number", y = "Number of Noise Exemptions")

ward_exemptions_bar
```

```{r}
#| label: fig-warddetails
#| fig-cap: "All Relevant Ward Details"
#| fig-subcap: ["Ward Area","Ward Population", "Ward Median Income"]
#| layout-ncol: 3
#| echo: false
#| warning: false
#| message: false

ward_dataset <- noise_exemp_ward_data %>% 
  select(ward, ward_area_km2, ward_population, ward_median_income) %>%
  # remove duplicates that occur because of data being joined
  distinct()

ward_area_plot = ward_dataset %>% 
  ggplot(aes(x = ward, y = ward_area_km2)) +
  geom_col() +
  theme_linedraw() +
  labs(x = "Ward Number", y = "Area (km squared)")
  
ward_population_plot = ward_dataset %>% 
  ggplot(aes(x = ward, y = ward_population)) +
  geom_col() +
  theme_linedraw() +
  labs(x = "Ward Number", y = "Population")

ward_median_income_plot = ward_dataset %>% 
  ggplot(aes(x = ward, y = ward_median_income)) +
  geom_col() +
  theme_linedraw() +
  labs(x = "Ward Number", y = "Median Income (CAD)")



ward_area_plot
ward_population_plot
ward_median_income_plot
```

\newpage

## Income Noise Exemption Relationship


```{r}
#| label: fig-wardtotalexemptionsscatterplots
#| fig-cap: "Noise Exemptions by Ward"
#| fig-subcap: ["TODO", "TODO", "TODO"]
#| layout-ncol: 3
#| echo: false
#| warning: false
#| message: false


correlation_data <- noise_exemp_ward_data %>% 
  group_by(ward, ward_median_income, ward_area_km2, 
           ward_population) %>% 
  summarise(
    num_exemptions = n_distinct(id),
    construction_exemptions = sum(permit_type == "construction"),
    non_construction_exemptions = sum(permit_type == "non-construction"),
    other_exemptions = sum(permit_type == "other")
  )

income_num_exemption <- correlation_data %>% 
  ggplot(aes(ward_median_income, num_exemptions)) +
  geom_point(alpha = 0.7) +
  theme_linedraw() +
  labs(x = "Median Income", y = "Number of Exemptions") + 
  geom_text(aes(label = ward), vjust = 1.5, hjust = 0.5, size = 2)

income_nonconstruction_exemptions <- correlation_data %>% 
  ggplot(aes(ward_median_income, non_construction_exemptions)) +
  geom_point(alpha = 0.7) +
  theme_linedraw() +
  labs(x = "Median Income", y = "Number of Non-construction Exemptions") + 
  geom_text(aes(label = ward), vjust = 1.5, hjust = 0.5, size = 2)

income_construction_exemptions <- correlation_data %>% 
  ggplot(aes(ward_median_income, construction_exemptions)) +
  geom_point(alpha = 0.7) +
  theme_linedraw() +
  labs(x = "Median Income", y = "Number of Construction Exemptions") + 
  geom_text(aes(label = ward), vjust = 1.5, hjust = 0.5, size = 2)


income_num_exemption
income_nonconstruction_exemptions
income_construction_exemptions

# TODO: delete before submission
test = correlation_data %>% filter(ward != 10)
cor.test(test$ward_median_income, test$num_exemptions)
cor.test(correlation_data$ward_median_income, correlation_data$num_exemptions)


# keep in mind that relationship looks weaker after potetnial outlier point
# removed

# TODO: ADD a section about these graphs even after they have been removed
```

\newpage

## Testing for Hidden Confounding relationships

```{r}
#| label: fig-confoudingplots
#| fig-cap: "Ward Median Income Relationship With Common Potential Confounds"
#| fig-subcap: ["TODO", "TODO"]
#| layout-ncol: 3
#| echo: false
#| warning: false
#| message: false


correlation_data <- noise_exemp_ward_data %>% 
  select(ward, ward_area_km2, ward_population, ward_median_income)

ward_income_pop <- correlation_data %>% filter(ward != 10) %>% 
  ggplot(aes(ward_median_income, ward_population)) +
  geom_point(alpha = 0.7) +
  theme_linedraw() +
  labs(x = "Median Income", y = "Population") + 
  geom_text(aes(label = ward), vjust = 1.5, hjust = 0.5, size = 2)

ward_income_area <- correlation_data %>% 
  ggplot(aes(ward_median_income, ward_area_km2)) +
  geom_point(alpha = 0.7) +
  theme_linedraw() +
  labs(x = "Median Income", y = "ward_area_plot (kms squared)") + 
  geom_text(aes(label = ward), vjust = 1.5, hjust = 0.5, size = 2)


ward_income_pop
ward_income_area

# TODO: DELETE BELOW CODE

cor.test(correlation_data$ward_median_income, correlation_data$ward_population)
cor.test(correlation_data$ward_median_income, correlation_data$ward_area_km2)

test = correlation_data %>% filter(ward != 10)
cor.test(test$ward_median_income, test$ward_population)
cor.test(test$ward_median_income, test$ward_area_km2)

# keep in mind that relationship looks weaker after potetnial outlier point
# removed (this is especially true for population)
```


```


\newpage

# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses/Limitations and next steps should also be included.

\newpage


# References

